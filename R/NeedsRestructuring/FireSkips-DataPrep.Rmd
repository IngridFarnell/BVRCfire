---
title: "Fire Skips Analysis"
author: "A. Clason"
date: "July 29, 2020"
output: html_document
---

I'm using the 2016 forest inventory, as any updates in 2017 would have simply been a modification based on fire severity. We are dealing with fire severity explicitly, so there's no need to use their interpretation of how much tree mortality occurred after the 2017 and 2018 fires. 

The 2018 fires in the Lakes District had a VRI update from 2013-2016, and Morice during a similar time with imagery based on 2013. Same with Quesnel west VRI update - was in 2013, interpreted and attributed up to 2016, and then updated via fire disturbance etc. after that. Without going through every single fire and determine the exact timing of VRI updates, it seems 2016 is the closest to the fire disturbances without incorporating 2017 and 2018 fires as % mortality linked to severity.

Fire year comes from the fire perimeter data
Fire date will come from the table put together by Sam et al. on official and analysis start and end dates

```{r}
library(data.table)
library(dplyr)
library(raster)
library(sf)
library(stringr)
library(readr)
library(ggplot2)
```


Spatial files - only bring in if running MakeFireDataTable.R
```{r}
#source(MakeFireDataTable.R) #if you need to actually run the fire table script to generate data tables. Could do it as a function instead where you pass a fireID and create a datatable from that

#Pathways:
#Study fire
study_fireTable <- fread("C:/Users/Alana2012/ALANA_FILES/GitHub/BVRCfire/inputs/StudyFireList.csv")

#All fire perimeters:
fire_perimeters <- read_sf("F:/Spatial Data/FCI_Fire_Regen_spatialfiles/Historical wildfire perimeters/BC Wildfire Historical Fire Perimeters.shp",quiet=TRUE)
fire_per_sel <- fire_perimeters %>%
  dplyr::select(FIRE_NUMBE,FIRE_YEAR,FIRE_CAUSE)

#write
#Severity mapping (all 2015-2018)
severity <- read_sf("F:/Spatial Data/FCI_Fire_Regen_spatialfiles/Burn severity 2015_2018/BurnSeverityRating_2018.shp", quiet=T)
severity_sel <- severity %>%
  dplyr::select(FIRE_NUMBE,FIRE_YEAR,BURN_SEVER)

#Results
#could include Generalize- these describe the BEC subzone/site series
Results_All <- read_sf("F:/Spatial Data/FCI_Fire_Regen_spatialfiles/RESULTS/RESULTS_FirePerimeter_Intersect.shp",
                       quiet=T)
Results_sel <- Results_All %>%
    dplyr::select(OPENING_ID,OPENING_ST,APPROVE_DA,DISTURBANC,DISTURBA_1,DENUDATION, DENUDATI_1, 
                  DENUDATI_2, DENUDATI_3,
                  DENUDATI_4,DENUDATI_5,DENUDATI_6,DENUDATI_7, DENUDATI_8, DENUDATI_9, DENUDAT_10, SITE_PREP_,
                  SITE_PREP1, SITE_PRE_1, SITE_PRE_2, SITE_PRE_3, SITE_PRE_4 ,SITE_PRE_5, PLANTING_1,PLANTING_2,
                  PLANTING_3, PLANTING_4, PLANTING_5, PLANTING_6, PLANTING_C ,BRUSHING_T,BRUSHING_1, BRUSHING_C,
                  BRUSHING_2 ,SPACING_TR, SPACING_CO ,SPACING__1, FERTILIZAT,FERTILIZ_1, FERTILIZ_2, PRUNING_TR,
                  PRUNING_CO ,PRUNING__1,SLOPE,ASPECT)

VRI_study <- read_sf("F:/Spatial Data/Fire/ForestManage_Fire/VRI2016_StudyFires.shp")

rm(severity)
rm(Results_All)
gc()

#BEC database:
BEC <- read_sf("F:/Spatial Data/BEC/Polygons/BECpolygons.shp")

#populated RESULTS data

#Should do a check on all layers to make sure same projection
Study_fire_perimeters <- as.data.table(fire_per_sel)[FIRE_NUMBE %in% c(study_fireTable[,FireID])]
write_sf(st_as_sf(Study_fire_perimeters),"Study_fire_perimeters.shp")

#Silviculture layer
Silv_All <- read_sf("F:/Spatial Data/Fire/ForestManage_Fire/RSLT_FCSLV_Fires.shp", quiet=T)
Silv_All_DT <- as.data.table(Silv_All)
#inventory layer
Inv_All <- read_sf("F:/Spatial Data/RESULTS/BCGW_7113060B_1609895346773_3020/RSLT_FOREST_COVER_INV_SVW/RSLT_FC_IN_polygon.shp", quiet=T)
Inv_All_DT <- as.data.table(Inv_All)

Silv_Inv <- merge(Silv_All_DT,Inv_All_DT, by="OPEN_ID")
#not the right layer yet, need to reclip the 2016 VRI
VRI_study <- read_sf("F:/Spatial Data/Fire/ForestManage_Fire/VRI2016_StudyFires.shp")
VRI_study_sel <- VRI_study %>%
  dplyr::select(BASAL_AREA, SPECIES_CD, SPECIES_PC, SPECIES__1, SPECIES__2, SPECIES__3, SPECIES__4, SPECIES__5,
                SPECIES__6, SPECIES__7,SPECIES__8, SPECIES__9,SPECIES_10)
VRI_study_DT <- as.data.table(VRI_study)
rm(VRI_study)
gc()

dem <- raster("")

```
Determining age of plantation isn't as straight-forward as I thought. We need to determine what constitutes a plantation to be included in this analysis:
- all openings with a minimum of 1 treatment? (cut, planting, spacing, brushing?)
or
- only openings that were harvested and planted
or 



The problem with the 50% cut-off on previous fire boundaries is that the size of the opening matters. Large openings will be unlikely to have as many previous fires meet that criteria, and small openings more




Working with firetable data
```{r}
#Fires with results:
dt <- data.table()
Plantations_ <- data.table()
for(j in 1:length(Fire_shortList)){
  dt <- fread(paste0("./Outputs/IndividualFires/",Fire_shortList[j],"_Firedat.csv"),
              colClasses = list(IDate =c("APPROVE_DA","DISTURBANC","DISTURBA_1","DENUDATI_4","DENUDATI_9",
                               "SITE_PRE_1","SITE_PRE_4","PLANTING_3","PLANTING_6","BRUSHING_C",
                               "SPACING_CO","FERTILIZ_1","PRUNING_CO")))
  dt[, ':='(FireID = Fire_shortList[j])]
  dt[,.N,by=OPENING_ID]
  dt[,.N]
  Plantations_ <- rbind(Plantations_,dt,fill=TRUE)
}
Plantations_ <- merge(Plantations,study_fireTable, by="FireID")
unique(Plantations_$DENUDATI_1)
unique(Plantations_$DENUDATI_6)
Plantations_[DENUDATI_1=="SHELT"]
###### Data checks #######
Plantations[,.N,by=OPENING_ID]
Plantations[,.N]
#check to make sure all the plantations are in fact plantations:
Plantations[,.N,c("DENUDATION","DENUDATI_5")]
Plantations[DENUDATION =="B" & is.na(DENUDATI_5)] #sites just with Burn call have site prep and planting. Good.
Plantations[DENUDATION =="W" & is.na(DENUDATI_5)] #same with windthrow
Plantations[DENUDATION =="L" & DENUDATI_5=="D"]
###########

Plantations[,TotOpenArea:=TotArea/10000] #area of the RESULTS opening
#Descriptions of plantations combined:
Plantations[,sum(TotOpenArea)]
Plantations[,.(sum(TotOpenArea),min(TotOpenArea),max(TotOpenArea),mean(TotOpenArea),median(TotOpenArea))]
hist(Plantations[,TotOpenArea])
Plantations[TotOpenArea<1000,.N]

###### AGE OF PLANTATION ######
Plantations2 <- Plantations[!is.na(PLANTING_1)| !is.na(PLANTING_4)]
Plantations3 <- Plantations[is.na(PLANTING_1) & is.na(PLANTING_4)]
Plantations2[, PlantAge := 
              pmax((as.numeric(format(as.Date(Plantations2[,StartDate],format="%d/%m/%Y"),"%Y")) -
                      as.numeric(format(as.Date(Plantations2[,PLANTING_3],format="%Y-%m-%d"),"%Y"))),
                   (as.numeric(format(as.Date(Plantations2[,StartDate],format="%d/%m/%Y"),"%Y")) -
                      as.numeric(format(as.Date(Plantations2[,PLANTING_6],format="%Y-%m-%d"),"%Y"))),
                              na.rm=TRUE)]
Plantations3[, PlantAge := 
              pmax((as.numeric(format(as.Date(Plantations3[,StartDate],format="%d/%m/%Y"),"%Y")) -
                      as.numeric(format(as.Date(Plantations3[,DENUDATI_4],format="%Y-%m-%d"),"%Y"))+1),
                   (as.numeric(format(as.Date(Plantations3[,StartDate],format="%d/%m/%Y"),"%Y")) -
                      as.numeric(format(as.Date(Plantations3[,DENUDATI_9],format="%Y-%m-%d"),"%Y"))+1),
                   (as.numeric(format(as.Date(Plantations3[,StartDate],format="%d/%m/%Y"),"%Y")) -
                      as.numeric(format(as.Date(Plantations3[,DISTURBANC],format="%Y-%m-%d"),"%Y"))+1),
                              na.rm=TRUE)]
PlantationsAge <- rbind(Plantations2,Plantations3)
range(PlantationsAge[,PlantAge])
PlantationsAge[PlantAge<0] #logging happened before the fire, but planting happened after. Change the age to 0
PlantationsAge[,PlantAge := ifelse(PlantAge<0,PlantAge==0,PlantAge)] 
range(PlantationsAge[,PlantAge])
hist(PlantationsAge[,PlantAge])
median(PlantationsAge[,PlantAge])


#summary information about openings in these study fires:
PlantationsAge[,.N,by=FireID]
#elephant hill has way more than others
PlantationsAge[,max(PlantAge),by=FireID]
PlantationsAge[is.na(PLANTING_1) & is.na(PLANTING_4),.N,by=FireID] #number of unplanted openings
PlantationsAge[is.na(PLANTING_1) & is.na(PLANTING_4),min(PlantAge),by=FireID] #age of unplanted openings

write.csv(PlantationsAge,"./Outputs/PlantationsAge.csv", row.names=FALSE)

PlantationsAge[PlantAge>45]
PlantationsAge[!is.na(DENUDATI_1) | !is.na(DENUDATI_6),.N]



```
 
Details from RESULTS 

need to reduce the openings to only those that count as plantations. Sheena and Ingrid populated all of them.
```{r}
#
dt <- data.table()
FireDetRes <- data.table()
for(i in c(8,9,12)){
  dt <- fread(paste0("./Outputs/IndividualFires/",Fire_shortList[i],"_Firedat_SitePrep_MethAdds.csv"),
                     na.strings=c("","NA","<NA>"))
  dt[, ':='(FireID = Fire_shortList[i])]
  FireDetRes <- rbind(FireDetRes,dt,fill=TRUE)
}
SitePrepType_melt <- melt(FireDetRes, id.vars = c("OPENING_ID"),
                      measure.vars = c("SITE_PREP_","SITE_PRE_2",
                                       "SITEPr_3_Type",
                                       "SITEPr_4_Type",
                                       "SITEPr_5_Type",
                                       "SITEPr_6_Type"),
                      variable.name = "SP",
                      value.name = "SP_type")

SitePrepMeth_melt <- melt(FireDetRes, id.vars = c("OPENING_ID"),
                      measure.vars = c("SITEPr_1_Meth",
                                       "SITEPr_2_Meth",
                                       "SITEPr_3_Meth",
                                       "SITEPr_4_Meth",
                                       "SITEPr_5_Meth",
                                       "SITEPr_6_Meth"),
                      variable.name = "SP_",
                      value.name = "SP_Method")
SitePrepDate_melt <- melt(FireDetRes, id.vars = c("OPENING_ID"),
                      measure.vars = c("SITE_PRE_1",
                                       "SITE_PRE_4",
                                       "SITEPr_3_Date",
                                       "SITEPr_4_Date",
                                       "SITEPr_5_Date",
                                       "SITEPr_6_Date"),
                      variable.name = "SP_3",
                      value.name = "SP_Date")
SitePrep <- SitePrepType_melt[,.(OPENING_ID,SP_type,
                                 SP_Method = SitePrepMeth_melt[,SP_Method],
                                 SP_Date = as.numeric(format(as.Date(SitePrepDate_melt[,SP_Date],
                                                                     format="%d/%m/%Y"),"%Y")))]
SitePrep <- SitePrep[!is.na(SP_type)&!is.na(SP_Method)]
SitePrep <- SitePrep[, SP_type_meth:= paste0(SP_type,"_",SP_Method)]
SitePrep[,.N,by=SP_type_meth]

ggplot(SitePrep)+
  geom_histogram(aes(x=SP_Date, fill=SP_Method), position="stack")

###### Treatment grouping #####
#treatments that mix the mineral soil:
SoilMix <- c("DISC","MOUND","CHAIN","SHARK","LRIP")
FlattenVeg <- c("","HAND","KNOCK")
TreePiling <- c("RPILE")
BurnTr <- c("SPOT","BROAD","LAND")

SitePrep[,.()]



ResultsSP <- merge(FireDetRes[,.(OPENING_ID, FireID, Num_SitePr=SITE_PRE_5)],SitePrep,by="OPENING_ID")
ResultsSP_PA <- merge(PlantationsAge[FireID %in% Fire_shortList[c(8,9,12)],.(FireID,OPENING_ID,OPENING_ST,
                                                                           SLOPE, ASPECT,High,Low,
                                                                           Medium, Unburned, TotArea,
                                                                           FIRE_YEAR, PropPfire,PlantAge,
                                                                           Spaced,Brushed,SitePrepped,
                                                                           Fertil,Prune)],
                      ResultsSP, by=c("OPENING_ID","FireID"), all=TRUE)




```


Looking at the data - bringing the graphs that are informative to the front
```{r}
library(ggpubr)
##histogram of plantation age
ggplot(PlantationsAge, aes(FireID, PlantAge))+
  geom_boxplot()

## graphs of proportion burned by plantation age
a <- ggplot(PlantationsAge,aes(y=Unburned, x=PlantAge))+
  geom_point()+
  geom_smooth(method = "gam")+
  ylim(0,1)
b <- ggplot(PlantationsAge,aes(y=Low, x=PlantAge))+
  geom_point()+
  geom_smooth(method = "gam")+
  ylim(0,1)
c <- ggplot(PlantationsAge,aes(y=Medium, x=PlantAge))+
  geom_point()+
  geom_smooth(method = "gam")+
  ylim(0,1)
d <- ggplot(PlantationsAge,aes(y=High, x=PlantAge))+
  geom_point()+
  geom_smooth(method = "gam")+
  ylim(0,1)
ggarrange(a,b,c,d)



ggplot(PlantationsAge[,.N,by=FireID],aes(x=FireID,y=N))+
  geom_bar(stat="identity")
ggplot(PlantationsAge[is.na(PLANTING_1) & is.na(PLANTING_4)], aes(FireID, PlantAge))+
  geom_boxplot()

ggplot(PlantationsAge, aes(PlantAge)) +
  geom_histogram(bins=30) 

ggplot(PlantationsAge, aes(PlantAge)) +
  geom_histogram(bins=10) +
  facet_wrap(vars(FireID), ncol=2) 

summary(lm(Unburned~Spaced, PlantationsAge))
summary(lm(Unburned~Brushed, PlantationsAge))
summary(lm(Unburned~SitePrepped, PlantationsAge))

cor_x <- cor(as.matrix(PlantationsAge[,.(Spaced,Brushed,SitePrepped,PlantAge,TotArea)]))
summary(lm(Unburned~Spaced + Brushed + SitePrepped + PlantAge + TotArea, data=PlantationsAge))
anova(lmer(Unburned~Spaced + Brushed + SitePrepped + PlantAge + TotArea +(1|FireID), data=PlantationsAge),
      ddf="Satterthwaite", type=2)




ggplot(PlantationsAge,aes(y=Low, x=SitePrepped))+
  geom_col()+
  ylim(0,1750)


ggplot(PlantationsAge,aes(y=Unburned, x=Spaced))+
  geom_col()
ggplot(PlantationsAge,aes(y=Unburned, x=Brushed))+
  geom_col()
ggplot(PlantationsAge,aes(y=High, x=TotArea))+
  geom_point()+
  geom_smooth(method="lm")

PlantationsAge[,sum(SitePrepped)]
PlantationsAge[,sum(Spaced)]
PlantationsAge[,sum(Brushed)]
ggplot(PlantationsAge,aes(y=High, x=SitePrepped))+
  geom_col()
ggplot(PlantationsAge,aes(y=High, x=Spaced))+
  geom_col()
ggplot(PlantationsAge,aes(y=High, x=Brushed))+
  geom_col()
ggplot(PlantationsAge,aes(y=Medium, x=SitePrepped))+
  geom_col()
ggplot(PlantationsAge,aes(y=Medium, x=Spaced))+
  geom_col()
ggplot(PlantationsAge,aes(y=Medium, x=Brushed))+
  geom_col()
ggplot(PlantationsAge,aes(y=Low, x=SitePrepped))+
  geom_col()
ggplot(PlantationsAge,aes(y=Low, x=Spaced))+
  geom_col()
ggplot(PlantationsAge,aes(y=Low, x=Brushed))+
  geom_col()
#this tells us how much of the plantations burned at different severities, but can't compare it to the rest of the fire
#I don't know that total area is right
ggplot(PlantationsAge,aes(y=HighArea, x=PlantAge))+
  geom_point()+
  geom_smooth()

ggplot(PlantationsAge,aes(y=MedArea, x=PlantAge))+
  geom_point()+
  geom_smooth()

ggplot(PlantationsAge,aes(y=LowArea, x=PlantAge))+
  geom_point()+
  geom_smooth()

ggplot(PlantationsAge,aes(y=UnburnArea, x=PlantAge))+
  geom_point()+
  geom_smooth()

ggplot(PlantationsAge,aes(y=High, x=PlantAge))+
  geom_point()+
  geom_smooth()

ggplot(PlantationsAge,aes(y=Medium, x=PlantAge))+
  geom_point()+
  geom_smooth()

ggplot(PlantationsAge,aes(y=Low, x=PlantAge))+
  geom_point()+
  geom_smooth()

ggplot(PlantationsAge,aes(y=Unburned, x=PlantAge))+
  geom_point()+
  geom_smooth()

```

Whole fire metrics
```{r}
#total area of the fire
fires <- fire_per_sel %>% filter(FIRE_NUMBE %in% Fire_shortList)
fires$TotFireArea <- st_area(fires)
firesDT <- as.data.table(fires)
firesDT[,TotFireArea := unclass(TotFireArea)/10000]
firesDTmerge <- firesDT[,.(FIRE_NUMBE,FIRE_YEAR,TotFireArea)]
firesDT[,sum(TotFireArea)]
############## All plantations summed ##########
#figuring out area wthin each fire severity category for the whole fire  - might have done this already??
Fire_Sev <- severity_sel %>% filter(FIRE_NUMBE %in% Fire_shortList)
#For every fire, calculate the area (ha) of each severity polygon
Fire_Sev$FireSevArea <- st_area(Fire_Sev)
Fire_SevDT <- as.data.table(Fire_Sev)
FireSevSum <- Fire_SevDT[,round(sum(unclass(FireSevArea)/10000),0),by=c("FIRE_NUMBE","BURN_SEVER")]
setnames(FireSevSum,"V1","FireSev")
#Openings and fire severity
PlantAgeLong <- melt(PlantationsAge[,.(FireID,OPENING_ID,High,Medium,Low,Unburned,TotOpenArea)],
                     id.vars = c("FireID","OPENING_ID","TotOpenArea"))
PlantAgeLong[,PropArea:= value*TotOpenArea]
PlantSevSum <- PlantAgeLong[,round(sum(na.omit(PropArea)),0),by=c("FireID","variable")]
setnames(PlantSevSum,"V1","PlantSev")
PlantFire_Sev <- merge(FireSevSum,PlantSevSum, by.x=c("FIRE_NUMBE","BURN_SEVER"),by.y=c("FireID","variable"))
PlantFire_Sev_Tot <- merge(PlantFire_Sev,firesDTmerge, by="FIRE_NUMBE")
PlantFire_Sev_Tot[,sum(PlantSev),by="FIRE_NUMBE"]
PlantFire_Sev_Tot[,sum(PlantSev)]
PlantFire_Sev_Tot[,sum(PlantSev)]



############# Overlapping polygons #############
#bringing in the overlapping polygons:
overlapPlantations <- merge(PlantationsAge[,.(OPENING_ID,FireID,TotOpenArea,PlantAge,Spaced,Brushed,SitePrepped,
                                              Fertil, Prune, Unburned, Low, Medium, High)], 
                            r_t_dat_p_Notself_, by="OPENING_ID", all.y=T)
overlapPlantations[PropResOverlap>0.9] #polygons with 100% overlap (30)

############### Unioned together ##############
#versus when unioned together (accounting for spatial overlap)
Plant_union <- fread("./Outputs/IndividualFires/PropBurnDat.csv")
Plant_union <- Plant_union %>% filter(FIRE_NUMBE %in% Fire_shortList)
Plant_union[,sum(PlantAreaSev),by="FIRE_NUMBE"]
Plant_union[,sum(na.omit(PlantAreaSev))] #unioned ==22713 - can't be right


PlantFire_Sev_PlUnion <-merge(PlantFire_Sev,Plant_union, by=c("FIRE_NUMBE","BURN_SEVER"))
###############################################
#What's the total amount of area in plantations by fire
ggplot(PlantFire_Sev_Tot[,sum(PlantSev)/sum(FireSev),by="FIRE_NUMBE"],aes(x=FIRE_NUMBE,y=V1))+
  geom_col()+
  xlab("Fires")+
  ylab("Proportion area in plantations")


############# Plantation severity ##############
#### Comparing plantation burns to proportion area in different severity classes
PlantFire_Sev_Tot[,PrPlSev := round(PlantSev/sum(PlantSev),3),by="FIRE_NUMBE"]
PlantFire_Sev_Tot[,PrFireSev := round(FireSev/sum(FireSev),3),by="FIRE_NUMBE"]

ggplot(PlantFire_Sev_Tot,aes(x=PrFireSev, y=PrPlSev, colour=BURN_SEVER))+
  geom_point()+
  geom_smooth(method = "lm", formula=y~x-1)+
  xlab("Proportion of total fire area")+
  ylab("Proportion of plantation fire area")+
  xlim(0,0.7)+
  ylim(0,0.7)


#area in each severity class across all fires - plantations vs not
AllFireSev <- PlantFire_Sev_Tot[,.(Plantations=sum(PlantSev), OverallFire=sum(FireSev)),by="BURN_SEVER"]
pf <-melt(AllFireSev,id.vars = "BURN_SEVER")
pf[, Proportion := value/sum(value), by=c("variable")]
levels(pf$BURN_SEVER) <- c("Unburned","Low","Medium","High")

ggplot(pf, aes(fill=BURN_SEVER, x=variable, y=value))+
  geom_col(position="stack")+
  ylab("Area in each burn severity class")+
  xlab("Area in plantations and total fire")

ggplot(pf, aes(fill=BURN_SEVER, x=variable, y=Proportion))+
  geom_col(position="stack")+
  ylab("Proportion each burn severity class")+
  xlab("Proportion in plantations and total fire")



#I think we want to force the intercept to be zero, so we can interpret the slopes
coef(lm(PrPlSev~PrFireSev-1, data=PlantFire_Sev_Tot[BURN_SEVER=="Unburned"]))
coef(lm(PrPlSev~PrFireSev-1, data=PlantFire_Sev_Tot[BURN_SEVER=="Low"]))
coef(lm(PrPlSev~PrFireSev-1, data=PlantFire_Sev_Tot[BURN_SEVER=="Medium"]))
coef(lm(PrPlSev~PrFireSev-1, data=PlantFire_Sev_Tot[BURN_SEVER=="High"]))

#a slope >1 suggests more than expected in planted compared to the whole fire
#a slope <1 suggests less than expected in planted compared to the whole fire
#There's more unburned in planted, the same low, less medium and less high,
#but biggest difference is less high
#this should work, but I'm struggling to interpret the estimates - 
summary(lm(PrPlSev~ BURN_SEVER + PrFireSev, data=PlantFire_Sev_Tot))
library(lme4)
summary(lmer(PrPlSev~ BURN_SEVER + PrFireSev + (1|FIRE_YEAR), data=PlantFire_Sev_Tot)) #very little variance associated with fire year
#Beta distribution might not be super simple to interpret slope
summary(betareg(PrPlSev~PrFireSev-1, data=PlantFire_Sev_Tot[BURN_SEVER=="Unburned"]))

### The next step is to describe the relative amount of severity across fires (how much high severity is out there)
PlantFire_Sev_Tot_melt <- melt(PlantFire_Sev_Tot[,.(FIRE_NUMBE,BURN_SEVER,FireSev,
                                                    PlantSev,FIRE_YEAR,TotFireArea)],
                               id.vars=c("FIRE_NUMBE","BURN_SEVER","FIRE_YEAR","TotFireArea"),
                               value.name = "Area.ha")

ggplot(PlantFire_Sev_Tot_melt, aes(fill=BURN_SEVER, x=variable, y=Area.ha))+
  geom_col(position="stack")+
  facet_wrap(vars(FIRE_NUMBE),ncol=3)

PlantFire_Sev_Tot_melt <- melt(PlantFire_Sev_Tot[,.(FIRE_NUMBE,BURN_SEVER,PrPlSev,
                                                    PrFireSev,FIRE_YEAR)],
                               id.vars=c("FIRE_NUMBE","BURN_SEVER","FIRE_YEAR"),
                               value.name = "Percent")
PlantFire_Sev_Tot[,.()]

ggplot(PlantFire_Sev_Tot_melt, aes(fill=BURN_SEVER, x=variable, y=Percent))+
  geom_col(position="stack")+
  ylab("cumulative proportion area burned (n=14 fires)")+
  xlab("Fire proportions vs proportions in plantations")
  facet_wrap(vars(FIRE_NUMBE),ncol=3)


#figuring out this high severity trend
PlantFire_Sev_Tot[,.(mn_FireSev = mean(PrFireSev), sd_FireSev = sd(PrFireSev)), by="BURN_SEVER"]
ggplot(PlantFire_Sev_Tot, aes(fill=BURN_SEVER, x=FIRE_NUMBE, y=PrFireSev))+
  geom_col(position="stack")+
  ylab("Proportion of area by severity class")#+
 # xlab("2017 & 2018 fires")+
  #facet_wrap(vars(FIRE_YEAR),ncol=2)
#so on average, there is very little high severity fire mean 0.07
#Is this paper really about what was driving the high severity fire? NO.

PlantFire_Sev_Tot_melt2 <- melt(PlantFire_Sev_Tot[,.(FIRE_NUMBE,BURN_SEVER,PrPlSev,PrFireSev,FIRE_YEAR,TotFireArea)],
                               id.vars=c("FIRE_NUMBE","BURN_SEVER","FIRE_YEAR","TotFireArea"))

ggplot(PlantFire_Sev_Tot_melt2[BURN_SEVER=="High"],aes(y=value, x=FIRE_NUMBE, group=variable, fill=variable))+
  geom_col(position="dodge")
  
ggplot(PlantFire_Sev_Tot_melt2,aes(y=value, x=FIRE_NUMBE, group=variable, fill=variable))+
  geom_col(position="dodge")+
  facet_wrap(vars(BURN_SEVER),ncol=2)
#how many fires follow the trend from the mean response across fires?
PlantFire_Sev_Tot[,PrDiff := (PrFireSev-PrPlSev)]
PlantFire_Sev_Tot[PrDiff>0,.N, by="BURN_SEVER"] #num of fires where prop overall fire > plantation prop
PlantFire_Sev_Tot[PrDiff<0,.N, by="BURN_SEVER"] #num of fires where prop overall fire < plantation prop
#so that follows the trend in the above regression analysis

#what's the relationship between area burned and proporiton of high severity
summary(lm(PrFireSev~TotFireArea, data=PlantFire_Sev_Tot[BURN_SEVER=="High"]))
ggplot(PlantFire_Sev_Tot[BURN_SEVER=="High"],aes(y=PrFireSev, x=TotFireArea))+
  geom_point()+
  geom_smooth(method = "lm", formula=y~x)#+

#no effect of fire size

#The percentage of all pieces of all openings within a fire (not the proportion of each opening and not the area)
#Proportion in each opening in each fire in each severity class
ggplot(PlantAgeLong, aes(fill=variable, x=FireID, y=value))+
  geom_col(position="stack")
#area of each opening in each fire in each severity class
ggplot(PlantAgeLong, aes(fill=variable, x=FireID, y=PropArea))+
  geom_col(position="stack")
```



```{r}
########## PLANTED SPECIES COMP ##########
Plantation_Res <- Results_sel %>% 
  filter(OPENING_ID %in% PlantationsAge$OPENING_ID)

Fire <- st_as_sf(Study_fire_perimeters %>% 
                   filter(FIRE_NUMBE == study_fireTable[12,FireID]))

VRI_fire <- VRI_study_sel %>%
  filter(st_contains(Fire, ., sparse = FALSE))

VRI_plantations <- filter(st_intersection(st_buffer(Plantation_Res,0), st_buffer(VRI_fire,0), sparse = FALSE))
write_sf(VRI_plantations,"VRI_plantations.shp")
VRI_plantations_DT <- as.data.table(VRI_plantations)
Fire1_VRI_Plantations <- merge(VRI_plantations_DT, Silv_Inv, by.x="OPENING_ID", by.y="OPEN_ID")

Plantations_Silv <- merge(PlantationsAge,Silv_Inv, by.x="OPENING_ID", by.y="OPEN_ID")

c("REF_YR", "PLY_NO","PLY_AR","S_SPP1_AG","SITE_INDEX","FC_SILV_TP","S_TSP_HA","S_TWS_HA","S_WS_HA",
  "S_FG_HA","S_CC_PCT","S_SPP1_CD","S_SPP1_PC","S_SPP1_AG","S_SPP1_HT","S_SPP2_CD","S_SPP2_PC","S_SPP2_AG",
  "S_SPP2_HT","S_SPP3_CD","S_SPP3_PC","S_SPP4_CD","S_SPP4_PC","S1_SPP5_CD","S_SPP5_PC")

#########################################

########### SOLAR RADIATION ##############


##########################################

##### FOREST SURROUNDING PLANTATION ######
Fire_Res_buff <- st_buffer(Fire_Results, 500)
Fire_Buff_Donut <- st_difference(st_make_valid(Fire_Results),st_make_valid(Fire_Res_buff))


##########################################

####### MODIS DAY OF BURN ################

fireDOB <- raster(paste0("./Outputs/DOB/",fire,"/dob.tif"))

#looking at agency mapped fire perimeters to compare to Shovel Lake produced by MODIS data
shovPeri <- st_read("F:/Spatial Data/Fire/Shovel Lake perimeter/Final_Peri/fire_peri.shp")
for(i in 1:length(unique(shovPeri$Date))){
  s <- subset(shovPeri, Date == unique(shovPeri$Date)[i])
  write_sf(s,paste0("F:/Spatial Data/Fire/Shovel Lake perimeter/Final_Peri/per_",
                    gsub(" ","",(unique(shovPeri$Date)[i])),".shp"))
}

##########################################

####### MODIS rate of spread #############
fireDOB <- raster(paste0("./Outputs/DOB/",fire,"/dob.tif"))
#Spread day is any day with spread > 240m (Wang et al 2014, based on Hirsch 1996)
#equals 1m/min assuming a 4h burning period each day and circular growth. But this isn't the same as actual fire progression. It just differentiates probable spread from nonspread days




```


Can start here with data table produced from above. Probably need to split this into 2 scripts - one makes the data tables for each fire and then this one analyses them.

working with site prep information 
Create a csv to go and populate the type of Method and Objective of a treatment. i.e burn method (landings, broadcast) or site prep (disc trench, mounding etc.)
```{r}
Fire1dat_ops[SITE_PREP_=="BU"|SITE_PRE_2=="BU"]

```

Covariates to calculate on data.table:
- solar radiation/landscape facets (I think I'll just stick with solar radiation)
- possibly look at free growing date (suggests over top of brush)
- site index - don't do it
```{r}

```



Working with CBI plot data:

```{r}
## Data
dat_compile <- read_csv("./inputs/Data for analysis - AllDataCompiled.csv")
dat_compile<- dplyr::select(dat_compile,-Notes)
## Shapefiles
#field plots polygons
FieldPlots <- read_sf(paste0(SpatialPaths,"All_field_plots_FINAL/All_field_plots_FINAL.shp"), quiet=TRUE)
FieldPlots <- rename(FieldPlots,AOS_year= YEAR) #BS004 - nas and blanks?
#field plot points
FieldPlotsPts <- read_sf(paste0(SpatialPaths,"Field_Plots/Field_Plots/Field_Plots.shp"))
FieldPlotsPts_tr <- st_transform(FieldPlotsPts,crs(FieldPlots))
#Carole Mahood's data
#Nadina lake Fire BA - R21721, Verdun - R11796, Shovel Lake - R11498
Nadina_CMahood <- read_sf(paste0(SpatialPaths,"Wildfires from Sam/R21721.shp"), quiet=TRUE)
Verdun_CMahood <- read_sf(paste0(SpatialPaths,"Wildfires from Sam/R11796.shp"), quiet=TRUE)
Shovel_CMahood <- read_sf(paste0(SpatialPaths,"Wildfires from Sam/R11498.shp"), quiet=TRUE)
colnames(Nadina_CMahood)
fires <- list(Nadina_CMahood,Verdun_CMahood,Shovel_CMahood)
col_sel_fn <- function(dat){
  dat_sel <- dat %>%
    dplyr::select(POLY_ID,INTRP_DATE,ATRIB_DATE,REF_DATE,BASAL_AREA,SPEC_CD_1,SPEC_PCT_1,SPEC_CD_2,
                  SPEC_PCT_2,SPEC_CD_3,SPEC_PCT_3,SPEC_CD_4,SPEC_PCT_4,SPEC_CD_5,SPEC_PCT_5,
                  SPEC_CD_6,SPEC_PCT_6,LIVE_STEMS,DEAD_STEMS)
  return(dat_sel)
}
Col_Sel <- lapply(fires,col_sel_fn)
fire_VRIS <- do.call(rbind,Col_Sel)

plots_vri <- st_join(FieldPlots,fire_VRIS)
plot(plots_vri$geometry)
uni_plots_vri <- unique(plots_vri)
write_sf(uni_plots_vri,"plots_vri.shp")
duplicated(uni_plots_vri)

#Bring in data compilation and merge datasets
FieldPlots_CompDat <- as.data.table(merge(dat_compile,uni_plots_vri, by.x="PlotID", by.y="PLOT"))
FieldPlots_CompDat[,geometry:=NULL]

FieldPlots_coords <-as.data.table(cbind(FieldPlotsPts_tr,st_coordinates(FieldPlotsPts_tr)))
FieldPlots_coords[,geometry:=NULL]
FieldPlots_coords$name <- str_replace(FieldPlots_coords$name,"Bs","BS")
grep("S", FieldPlots_coords)

FPmerge1 <- merge(FieldPlots_CompDat,FieldPlots_coords, by.x="PlotID",by.y="name")

write.csv(FieldPlots_CompDat,"FieldPlots_CompDat.csv")
```


Extras from FireDat prep
```{r}
#Fires in the study:
Study_fire_perimeters <- as.data.table(fire_per_sel)[FIRE_NUMBE %in% c(study_fireTable[,FireID])]
#write_sf(st_as_sf(Study_fire_perimeters),"Study_fire_perimeters.shp")

#split out by fire to reduce data in memory
FireNames <- as.list(study_fireTable[,FireID])
Fire1 <- st_as_sf(Study_fire_perimeters %>% 
  filter(FIRE_NUMBE == study_fireTable[1,FireID]))

####### RESULTS ########
#RESULTS - only results polygons from selected fire - really a clip. so st_intersect works
Fire1_Results <- Results_sel %>% 
  filter(st_contains(Fire1, ., sparse = FALSE))
#write_sf(Fire1_Results,"Fire1_Results.shp")
########################

####### SEVERITY ########
# and results for the fire
Fire1_Sev <- severity_sel %>% filter(FIRE_NUMBE == study_fireTable[1,FireID]) #Option 1
#Fire1_Sev <- severity_sel %>% 
 # filter(st_intersects(Fire1, ., sparse = FALSE)) #clip severity
#Fire1_severity <- st_intersection(Fire1_Sev,Fire1_Results, left=TRUE)
Fire1_sev_res <- st_intersection(st_buffer(Fire1_Results,0),st_buffer(Fire1_Sev,0))
#write_sf(Fire1_sev_res,"Fire1_sev_res.shp")
#Fire1_sev_res_dat <- as.data.table(Fire1_sev_res)
#plot(filter(Fire1_sev_res,OPENING_ID==-164410000)[45])
#filter(Fire1_sev_res, OPENING_ID== -164410000)
#plot(filter(Fire1_sev_res, OPENING_ID== -164410000)$geometry)

#so for every opening, we can calculate the proportion burned in each category
Fire1_sev_res$area <- st_area(Fire1_sev_res)
Fire1_sev_res_dat <- as.data.table(Fire1_sev_res)
BurnSev_prop_calcl <- Fire1_sev_res_dat[,sum(unclass(area)),
                                        by=.(OPENING_ID,BURN_SEVER)][,.(BURN_SEVER,BU_SV_P=prop.table(V1)),
                                                                     OPENING_ID]
BurnSev_prop_calcl_d <- dcast(BurnSev_prop_calcl,OPENING_ID~BURN_SEVER,value.var="BU_SV_P")
Fire1_Results_PropSev <- merge(Fire1_Results,BurnSev_prop_calcl_d, by="OPENING_ID")
#write_sf(Fire1_Results_PropSev,"Fire1_Results_PropSev.shp")
Fire1_Results_PropSev_dat <- as.data.table(Fire1_Results_PropSev)[,geometry:=NULL]
#write.csv(Fire1_Results_PropSev_dat,"Fire1_Results_PropSev_dat.csv")

#plot(filter(Fire1_Results_PropSev,OPENING_ID==-164410000)["Low"])
###########################

##### PREVIOUS FIRES ######
#Clip previous fires by current fire boundary
Fire1_Pfire <- fire_perimeters %>% 
  filter(st_contains(Fire1, ., sparse = FALSE)) %>% 
  filter(FIRE_NUMBE != study_fireTable[1,FireID]) 
#just where there are intersections, but need to join with the rest
Fire1_Pfire_res <-  filter(st_intersection(st_buffer(Fire1_Results_PropSev,0),st_buffer(Fire1_Pfire,0),sparse=FALSE))
#should probably do the same here, where there's a proportion of opening that burned
#t <- filter(Fire1_Pfire_res, OPENING_ID==1724418|OPENING_ID==1712009) #these polygons are only the overlap
Fire1_Pfire_res$area <- st_area(Fire1_Pfire_res) #area of the previous fire
Fire1_Results_PropSev$TotArea <- st_area(Fire1_Results_PropSev) #area of the total results opening
t_dat <- as.data.table(Fire1_Pfire_res)[,.(OPENING_ID,FIRE_YEAR,FIRE_CAUSE, PFireArea=unclass(area))] 
r_dat <- as.data.table(Fire1_Results_PropSev)
r_t_dat <- merge(r_dat[,.(OPENING_ID, TotArea=unclass(TotArea))],t_dat, by.x="OPENING_ID",by.y="OPENING_ID")
r_t_dat_p <- r_t_dat[, .(FIRE_YEAR,FIRE_CAUSE, PropPfire= PFireArea/TotArea), by="OPENING_ID"]
hist(r_t_dat_p[,mean(PropPfire),by="OPENING_ID"][,V1])

Fire1_Results_PropSev_Pfire <- merge(Fire1_Results_PropSev,r_t_dat_p,by="OPENING_ID",all=TRUE)
#write_sf(Fire1_Results_PropSev_Pfire,"Fire1_Results_PropSev_Pfire.shp")
Fire1_Results_PropSev_Pfire_dat <- as.data.table(Fire1_Results_PropSev_Pfire)[,geometry:=NULL]
#write.csv(Fire1_Results_PropSev_Pfire_dat,"Fire1_Results_PropSev_Pfire_dat.csv")
#############################
Fire1dat <- Fire1_Results_PropSev_Pfire_dat

#old vri query:
#1. If the VRI has a polygon representing the opening, use this for forest cover
    #the shapes won't match, so use absolutely ANY of the disturbance date columns to match with VRI harvest date,
    #then use this VRI for FT, projected height & canopy closure at time of fire
    #could try something like %m+% months(6) to get plus or %m-% months(6) minus 6 months within harvest date
    f <- merge(Fire_sev_res_vriDT[as.Date(DISTURBANC,format="%Y/%m/%D")  == as.Date(HARVEST_DA,format="%Y/%m/%D")|
                                    as.Date(DENUDATI_4,format="%Y/%m/%D") == as.Date(HARVEST_DA,format="%Y/%m/%D")|
                                    as.Date(DENUDATI_9,format="%Y/%m/%D") == as.Date(HARVEST_DA,format="%Y/%m/%D")|
                                    as.Date(DISTURBA_1,format="%Y/%m/%D") == as.Date(HARVEST_DA,format="%Y/%m/%D")|
                                    as.Date(APPROVE_DA,format="%Y/%m/%D") == as.Date(HARVEST_DA,format="%Y/%m/%D")],
               VRI_sum_all[,.(FEATURE_ID,decidCov,conifCov,PineCov, FirCov, SpruceCov, DFirCov)],by="FEATURE_ID")
    #because there's multiple VRI polygons associated with an opening, even with the above query, need to average covers
    #using leading species age and height here
    harvestVRI <- f[,.(DecVRICov=mean(na.omit(decidCov)),ConVRICov=mean(na.omit(conifCov)),
                       PineVRICov=mean(na.omit(PineCov)),FirVRICov=mean(na.omit(FirCov)),
                       SpruVRICov=mean(na.omit(SpruceCov)),DFirVRICov=mean(na.omit(DFirCov)),
                       CanopCloVRI = mean(na.omit(CROWN_CLOS)), AgeVRI =mean(na.omit(PROJ_AGE_1)),
                       HeightVRI = mean(na.omit(PROJ_HEIGH)), 
                       BA_VRI = mean(na.omit(BASAL_AREA)),HarVRI=1),by="OPENING_ID"]
    
    #when there is no harvest call in the VRI, use averages to estimate sp, age, etc.
    g <- merge(Fire_sev_res_vriDT[!(OPENING_ID %in% harvestVRI$OPENING_ID)],
               VRI_sum_all[,.(FEATURE_ID,decidCov,conifCov,PineCov, FirCov, SpruceCov, DFirCov)],by="FEATURE_ID")
    harvestVRI_Avg <- g[!(OPENING_ID %in% harvestVRI$OPENING_ID),
                        .(DecVRICov=mean(na.omit(decidCov)),ConVRICov=mean(na.omit(conifCov)),
                          PineVRICov=mean(na.omit(PineCov)),FirVRICov=mean(na.omit(FirCov)),
                          SpruVRICov=mean(na.omit(SpruceCov)),DFirVRICov=mean(na.omit(DFirCov)),
                          CanopCloVRI = mean(na.omit(CROWN_CLOS)), AgeVRI =mean(na.omit(PROJ_AGE_1)),
                          HeightVRI = mean(na.omit(PROJ_HEIGH)), 
                          BA_VRI = mean(na.omit(BASAL_AREA)), HarVRI=0),by="OPENING_ID"]

    harvestVRI_ <- rbind(harvestVRI_Avg,harvestVRI)
    #combine with Results and proportion fire severity
    Fire_Results_PropSev_PreFor <- merge(Fire_Results_PropSev,harvestVRI_, by="OPENING_ID")

```

